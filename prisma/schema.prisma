// ==============================
// DATASOURCE & GENERATOR
// ==============================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==============================
// MODELS
// ==============================

// ------------------------------
// CLIENT (Müvekkil)
// ------------------------------
model Client {
  id          String   @id @default(cuid())
  clientNumber String?  @unique  // CLT-0001, CLT-0002, etc. - for easy client identification
  name        String
  email       String   @unique
  phone       String?
  mobile      String?
  company     String?
  type        String    // Individual | Corporate
  status      String    // Active | Inactive
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String?
  taxId       String?   // Tax ID / SSN
  notes       String?   // Additional notes
  
  // Client Portal Authentication
  passwordHash String?  // For client portal login
  portalEnabled Boolean @default(false)  // Enable/disable client portal access
  lastLogin    DateTime?
  
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @updatedAt

  matters  Matter[]
  invoices Invoice[]
  clientMessages ClientMessage[]  // Messages from client to attorney
  notifications Notification[]    // Client notifications
  appointmentRequests AppointmentRequest[]  // Randevu talepleri
  signatureRequests SignatureRequest[]  // E-imza talepleri
  trustLedgers ClientTrustLedger[]  // IOLTA trust ledgers for this client
}

// ------------------------------
// MATTER (Dava Dosyası)
// ------------------------------
model Matter {
  id                  String        @id @default(cuid())
  caseNumber          String
  name                String
  practiceArea        String
  courtType           String?
  // Bail / Kefalet
  bailStatus          String?   // 'None', 'Set', 'Posted', 'Forfeited', 'Exonerated', 'Returned'
  bailAmount          Float?
  outcome             String?   // 'Dismissed', 'Convicted', 'Acquitted', 'Settled'
       // e.g. High Criminal, Family, etc.
  status              String        // Open | Closed
  feeStructure        String        // Hourly | Fixed
  openDate            DateTime      @default(now())
  responsibleAttorney String
  billableRate        Float
  trustBalance        Float         @default(0)

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  timeEntries TimeEntry[]
  expenses    Expense[]
  tasks       Task[]
  events      CalendarEvent[]
  clientMessages ClientMessage[]  // Messages related to this matter
  documents   Document[]  // Documents related to this matter
  invoices    Invoice[]   // Invoices for this matter
  trustTransactions TrustTransaction[]  // Trust account transactions
  settlementStatements SettlementStatement[]  // Settlement statements
}

// ------------------------------
// TASK (Görev)
// ------------------------------
model Task {
  id         String   @id @default(cuid())
  title      String
  description String?
  dueDate    DateTime?
  reminderAt DateTime?
  priority   String    // High | Medium | Low
  status     String
  outcome    String?   // success | failed | cancelled - for completed tasks
  matterId   String?
  matter     Matter?   @relation(fields: [matterId], references: [id])
  assignedTo String?

  templateId String?
  template   TaskTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Çalışan ataması
  assignedEmployeeId String?
  assignedEmployee   Employee? @relation("EmployeeTasks", fields: [assignedEmployeeId], references: [id])

  completedAt DateTime?
  userId      String?   // Data Isolation için
  reminderSent Boolean  @default(false) // Bildirim gönderildi mi?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ------------------------------
// TASK TEMPLATE (Görev Şablonu)
// ------------------------------
model TaskTemplate {
  id           String   @id @default(cuid())
  name         String
  category     String?  // e.g. "İcra", "Ceza", "Şirketler"
  description  String?
  definition   String   // JSON string: template tasks + offsets + defaults
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tasks        Task[]
}

// ------------------------------
// TIME ENTRY (Zaman Kayıtları)
// ------------------------------
model TimeEntry {
  id          String   @id @default(cuid())
  matterId    String?
  matter      Matter?  @relation(fields: [matterId], references: [id])
  description String
  duration    Int       // dakika
  rate        Float
  date        DateTime
  billed      Boolean   @default(false)
  type        String    // time
  userId      String?   // Data Isolation için
}

// ------------------------------
// EXPENSE (Gider Kaydı)
// ------------------------------
model Expense {
  id          String   @id @default(cuid())
  matterId    String?
  matter      Matter?  @relation(fields: [matterId], references: [id])
  description String
  amount      Float
  date        DateTime
  category    String
  billed      Boolean   @default(false)
  type        String    // expense
  userId      String?   // Data Isolation için
}

// ------------------------------
// LEAD (CRM – Potansiyel Müşteri)
// ------------------------------
model Lead {
  id             String   @id @default(cuid())
  name           String
  source         String
  status         String     // New | Contacted | Converted | Lost
  estimatedValue Float
  practiceArea   String
}

// ------------------------------
// CALENDAR EVENT (Ajanda Etkinliği)
// ------------------------------
model CalendarEvent {
  id       String   @id @default(cuid())
  title    String
  date     DateTime
  type     String    // Meeting | Court | Deadline
  matterId String?
  matter   Matter?   @relation(fields: [matterId], references: [id])
  userId   String?   // Data Isolation için
  reminderMinutes Int? // Kaç dakika önce hatırlatılacak
  reminderSent Boolean @default(false) // Bildirim gönderildi mi?
}

// ------------------------------
// INVOICE STATUS (Fatura Durumu)
// ------------------------------
enum InvoiceStatus {
  DRAFT              // Taslak
  PENDING_APPROVAL   // Onay Bekliyor
  APPROVED           // Onaylandı
  SENT               // Gönderildi
  PARTIALLY_PAID     // Kısmi Ödendi
  PAID               // Ödendi
  OVERDUE            // Vadesi Geçti
  WRITTEN_OFF        // Silindi/Write-off
  CANCELLED          // İptal
}

// ------------------------------
// LINE ITEM TYPE (Kalem Tipi)
// ------------------------------
enum LineItemType {
  TIME               // Zaman
  EXPENSE            // Masraf
  FIXED_FEE          // Sabit Ücret
  DISCOUNT           // İndirim
  TAX                // Vergi
  WRITE_OFF          // Silme
  RETAINER           // Avans
  COURT_FEE          // Mahkeme Harcı
  OTHER              // Diğer
}

// ------------------------------
// INVOICE (Fatura)
// ------------------------------
model Invoice {
  id        String   @id @default(cuid())
  number    String   @unique
  
  // Tutarlar
  subtotal  Float    @default(0)    // Ara toplam
  taxRate   Float?                  // Vergi oranı (%)
  taxAmount Float    @default(0)    // Vergi tutarı
  discount  Float    @default(0)    // İndirim tutarı
  amount    Float                   // Toplam tutar
  amountPaid Float   @default(0)    // Ödenen tutar
  balance   Float    @default(0)    // Kalan bakiye
  
  // Tarihler
  issueDate DateTime @default(now()) // Düzenleme tarihi
  dueDate   DateTime                  // Vade tarihi
  paidDate  DateTime?                 // Ödeme tarihi
  
  // Durum ve Workflow
  status    InvoiceStatus @default(DRAFT)
  approvedBy String?                  // Onaylayan
  approvedAt DateTime?                // Onay tarihi
  sentAt    DateTime?                 // Gönderilme tarihi
  
  // LEDES/UTBMS
  ledesCode String?                   // LEDES invoice code
  
  // İlişkiler
  clientId  String
  client    Client    @relation(fields: [clientId], references: [id])
  matterId  String?
  matter    Matter?   @relation(fields: [matterId], references: [id])
  
  // Alt tablolar
  lineItems InvoiceLineItem[]
  payments  InvoicePayment[]
  
  // Notlar ve Açıklamalar
  notes     String?
  terms     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ------------------------------
// INVOICE LINE ITEM (Fatura Kalemi)
// ------------------------------
model InvoiceLineItem {
  id          String        @id @default(cuid())
  invoiceId   String
  invoice     Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  type        LineItemType
  description String
  quantity    Float         @default(1)
  rate        Float         @default(0)
  amount      Float         // quantity * rate
  
  // LEDES/UTBMS kodları
  utbmsActivityCode String? // L110, L120 vb.
  utbmsExpenseCode  String? // E101, E102 vb.
  utbmsTaskCode     String? // Task code
  
  // İlişkili kayıtlar
  timeEntryId String?       // Bağlı zaman kaydı
  expenseId   String?       // Bağlı masraf
  
  taxable     Boolean       @default(true)
  billable    Boolean       @default(true)
  writtenOff  Boolean       @default(false)
  
  date        DateTime      @default(now())
  createdAt   DateTime      @default(now())
}

// ------------------------------
// INVOICE PAYMENT (Fatura Ödemesi)
// ------------------------------
model InvoicePayment {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  amount      Float
  method      String   // cash, check, credit_card, bank_transfer, trust
  reference   String?  // Check number, transaction ID
  
  // Stripe entegrasyonu
  stripePaymentId String?
  
  // Refund
  isRefund    Boolean  @default(false)
  refundReason String?
  
  notes       String?
  paidAt      DateTime @default(now())
  createdAt   DateTime @default(now())
}

// ------------------------------
// EMPLOYEE ROLE (Çalışan Rolleri)
// ------------------------------
enum EmployeeRole {
  SECRETARY       // Sekreter
  PARALEGAL       // Paralegal
  INTERN_LAWYER   // Stajyer Avukat
  ACCOUNTANT      // Muhasebeci
  ATTORNEY        // Avukat
}

// ------------------------------
// EMPLOYEE STATUS (Çalışan Durumu)
// ------------------------------
enum EmployeeStatus {
  ACTIVE          // Aktif
  ON_LEAVE        // İzinli
  TERMINATED      // İşten Ayrıldı
}

// ------------------------------
// EMPLOYEE (Çalışan)
// ------------------------------
model Employee {
  id              String         @id @default(cuid())
  firstName       String
  lastName        String
  email           String         @unique
  phone           String?
  mobile          String?
  role            EmployeeRole
  status          EmployeeStatus @default(ACTIVE)
  
  // Çalışma Bilgileri
  hireDate        DateTime       @default(now())
  terminationDate DateTime?
  hourlyRate      Float?
  salary          Float?
  
  // Sistem Hesabı (Giriş yapabilmesi için)
  userId          String?        @unique
  user            User?          @relation(fields: [userId], references: [id])
  
  // Notlar ve İletişim
  notes           String?
  address         String?
  emergencyContact String?
  emergencyPhone  String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // İlişkiler
  assignedTasks   Task[]         @relation("EmployeeTasks")
  supervisorId    String?
  supervisor      Employee?      @relation("EmployeeSupervisor", fields: [supervisorId], references: [id])
  subordinates    Employee[]     @relation("EmployeeSupervisor")
}

// ------------------------------
// USER (Sistem Kullanıcısı)
// ------------------------------
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  role         String   // Admin | Partner | Associate | Employee
  passwordHash String
  phone        String?
  mobile       String?
  address      String?
  city         String?
  state        String?
  zipCode      String?
  country      String?
  barNumber    String?   // Bar association number
  bio          String?   // Professional bio
  avatar       String?   // Avatar URL
  preferences  String?   // JSON string for user preferences
  notificationPreferences String? // JSON string for notification settings
  employeeRole String?   // For employee users: SECRETARY | PARALEGAL | INTERN_LAWYER | ACCOUNTANT
  createdAt    DateTime? @default(now())
  updatedAt    DateTime? @updatedAt

  notifications     Notification[]
  pushSubscriptions PushSubscription[]
  employee          Employee?
}

// ------------------------------
// NOTIFICATION (Bildirim)
// ------------------------------
model Notification {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId  String?  // For client notifications
  client    Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String   // info | warning | error | success
  read      Boolean  @default(false)
  link      String?  // Optional link to related item
  createdAt DateTime @default(now())
}

// ------------------------------
// CLIENT MESSAGE (Müvekkil Mesajı)
// ------------------------------
model ClientMessage {
  id        String   @id @default(cuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  matterId  String?  // Optional: related to a specific matter
  matter    Matter?  @relation(fields: [matterId], references: [id])
  subject   String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ------------------------------
// DOCUMENT (Doküman)
// ------------------------------
model Document {
  id          String   @id @default(cuid())
  name        String
  fileName    String   // Original file name
  filePath    String   // Server file path
  fileSize    Int      // Size in bytes
  mimeType    String   // MIME type
  matterId    String?
  matter      Matter?  @relation(fields: [matterId], references: [id], onDelete: Cascade)
  uploadedBy  String?  // User ID who uploaded
  version     Int      @default(1)
  groupKey     String? // Basic versioning key (e.g. matterId+fileName)
  category     String? // Contract, Notice, Court Order, etc.
  description String?
  tags        String?  // JSON string array of tags
  textContent String?  // Extracted text for search (PDF/text)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  signatureRequests SignatureRequest[]  // E-imza talepleri
  versions          DocumentVersion[]   // Version history
}

// ------------------------------
// DOCUMENT VERSION (Doküman Versiyonu)
// ------------------------------
model DocumentVersion {
  id            String   @id @default(cuid())
  documentId    String
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  versionNumber Int
  fileName      String
  filePath      String
  fileSize      Int
  mimeType      String
  
  // Değişiklik bilgisi
  changeNote    String?
  changedBy     String?   // User who made changes
  
  // Karşılaştırma için
  checksum      String?   // MD5/SHA hash
  diffSummary   String?   // JSON: what changed from previous version
  
  isLatest      Boolean   @default(false)
  createdAt     DateTime  @default(now())
}

// ------------------------------
// DEADLINE RULE TYPE
// ------------------------------
enum DeadlineRuleType {
  COURT_FILING     // Mahkeme dosyalama
  RESPONSE_DUE     // Cevap süresi
  DISCOVERY        // Keşif
  MOTION           // Dilekçe
  APPEAL           // Temyiz
  STATUTE_OF_LIMIT // Zamanaşımı
  CONTRACT         // Sözleşme
  CUSTOM           // Özel
}

// ------------------------------
// DEADLINE RULE (Son Tarih Kuralı)
// ------------------------------
model DeadlineRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        DeadlineRuleType
  
  // Süre hesaplama
  baseDays    Int      // Temel gün sayısı
  useBusinessDays Boolean @default(true)  // İş günü mü?
  excludeHolidays Boolean @default(true)  // Tatilleri hariç tut?
  
  // Trigger koşulları
  triggerEvent String?  // service_date, filing_date, etc.
  jurisdiction String?  // Yargı bölgesi
  practiceArea String?  // Uygulama alanı
  
  // Hatırlatma ayarları (JSON array: [30, 7, 1])
  reminderDays String?  // JSON: [30, 7, 1] = T-30, T-7, T-1
  
  // Uygulama
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Hesaplanan deadline'lar
  calculatedDeadlines CalculatedDeadline[]
}

// ------------------------------
// CALCULATED DEADLINE (Hesaplanmış Son Tarih)
// ------------------------------
model CalculatedDeadline {
  id            String       @id @default(cuid())
  ruleId        String
  rule          DeadlineRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  matterId      String
  
  // Tarihler
  triggerDate   DateTime     // Başlangıç tarihi
  dueDate       DateTime     // Hesaplanan son tarih
  
  // Hatırlatma durumu
  reminder30Sent Boolean     @default(false)
  reminder7Sent  Boolean     @default(false)
  reminder1Sent  Boolean     @default(false)
  
  // Durum
  status        String       @default("pending") // pending, completed, overdue
  completedAt   DateTime?
  notes         String?
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

// ------------------------------
// AUDIT LOG (İşlem Kayıtları)
// ------------------------------
model AuditLog {
  id          String   @id @default(cuid())
  userId      String?  // User who performed the action (attorney/admin)
  userEmail   String?  // User email for reference
  clientId    String?  // Client who performed the action (if client action)
  clientEmail String?  // Client email for reference
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, DOWNLOAD, VIEW, etc.
  entityType  String   // User, Client, Matter, Invoice, Document, etc.
  entityId    String?  // ID of the affected entity
  oldValues   String?  // JSON string of old values
  newValues   String?  // JSON string of new values
  details     String?  // Additional details about the action
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
}

// ------------------------------
// PASSWORD RESET TOKEN
// ------------------------------
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ------------------------------
// DOCUMENT TEMPLATE (Doküman Şablonu)
// ------------------------------
model DocumentTemplate {
  id          String   @id @default(cuid())
  name        String
  category    String   // Dilekçe, Sözleşme, İhtarname, vb.
  description String?
  content     String   // Template content with variables like {{client_name}}, {{date}}
  variables   String?  // JSON array of variable definitions
  isActive    Boolean  @default(true)
  createdBy   String?  // User ID who created
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ------------------------------
// REMINDER (Hatırlatıcı)
// ------------------------------
model Reminder {
  id          String   @id @default(cuid())
  type        String   // email, sms, notification
  triggerAt   DateTime
  sent        Boolean  @default(false)
  sentAt      DateTime?
  entityType  String   // CalendarEvent, Task, Matter
  entityId    String
  userId      String?
  message     String?
  createdAt   DateTime @default(now())
}

// ------------------------------
// PUSH SUBSCRIPTION (Web Push Subscription)
// ------------------------------
model PushSubscription {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint    String   @unique
  p256dh      String   // Public key for push encryption
  auth        String   // Auth secret
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ------------------------------
// PAYMENT (Ödeme - Stripe)
// ------------------------------
model Payment {
  id              String   @id @default(cuid())
  invoiceId       String
  amount          Float
  currency        String   @default("usd")
  status          String   // pending, succeeded, failed, refunded
  stripePaymentId String?  // Stripe PaymentIntent ID
  stripeChargeId  String?  // Stripe Charge ID
  paymentMethod   String?  // card, bank_transfer, etc.
  last4           String?  // Last 4 digits of card
  brand           String?  // Card brand (visa, mastercard, etc.)
  receiptUrl      String?  // Stripe receipt URL
  metadata        String?  // JSON string for additional data
  paidAt          DateTime?
  refundedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ------------------------------
// PAYMENT REMINDER (Ödeme Hatırlatıcı)
// ------------------------------
model PaymentReminder {
  id          String   @id @default(cuid())
  invoiceId   String
  type        String   // email, sms, push
  scheduledAt DateTime
  sentAt      DateTime?
  sent        Boolean  @default(false)
  message     String?
  createdAt   DateTime @default(now())
}

// ------------------------------
// TRUST TRANSACTION TYPE
// ------------------------------
enum TrustTransactionType {
  DEPOSIT          // Para yatırma
  WITHDRAWAL       // Para çekme (earned olarak)
  TRANSFER_IN      // Başka matter'dan transfer
  TRANSFER_OUT     // Başka matter'a transfer
  REFUND_TO_CLIENT // Müşteriye iade
  FEE_EARNED       // Kazanılmış ücret (operating'e transfer)
  INTEREST         // Faiz (varsa)
}

// ------------------------------
// TRUST TRANSACTION (Emanet Hesap İşlemi)
// ------------------------------
model TrustTransaction {
  id          String   @id @default(cuid())
  matterId    String
  matter      Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  
  type        TrustTransactionType
  amount      Float
  description String
  reference   String?  // Check number, wire reference etc.
  
  // IOLTA Tracking
  isEarned    Boolean  @default(false) // Para kazanıldı mı?
  earnedDate  DateTime?                // Ne zaman earned oldu
  
  // Running balance
  balanceBefore Float  @default(0)
  balanceAfter  Float  @default(0)
  
  // Audit
  createdBy   String?  // User who created
  approvedBy  String?  // Partner who approved (for large amounts)
  approvedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ------------------------------
// TRUST REQUEST (Emanet Talebi)
// ------------------------------
model TrustRequest {
  id              String   @id @default(cuid())
  matterId        String
  clientId        String
  
  requestedAmount Float
  currentBalance  Float
  minimumRequired Float     // Minimum threshold
  
  status          String    @default("pending") // pending, sent, paid, cancelled
  
  // İletişim
  emailSentAt     DateTime?
  reminderCount   Int       @default(0)
  lastReminderAt  DateTime?
  
  notes           String?
  paidAt          DateTime?
  
  createdBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ------------------------------
// APPOINTMENT REQUEST (Randevu Talebi)
// ------------------------------
model AppointmentRequest {
  id            String   @id @default(cuid())
  clientId      String
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  matterId      String?
  requestedDate DateTime
  duration      Int      @default(30) // minutes
  type          String   // consultation, meeting, call, court
  notes         String?
  status        String   @default("pending") // pending, approved, rejected, cancelled
  assignedTo    String?  // Attorney user ID
  approvedDate  DateTime? // Final approved date/time
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ------------------------------
// WORKFLOW (Otomasyon Akışı)
// ------------------------------
model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     String   // matter_created, status_changed, deadline_approaching, task_completed, invoice_created
  triggerConfig String? // JSON: conditions for trigger
  actions     String   // JSON array of actions
  isActive    Boolean  @default(true)
  runCount    Int      @default(0)
  lastRunAt   DateTime?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  executions  WorkflowExecution[]  // Execution history
}

// ------------------------------
// WORKFLOW EXECUTION LOG
// ------------------------------
model WorkflowExecution {
  id          String   @id @default(cuid())
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  triggeredBy String   // entity that triggered: matter_id, task_id etc.
  status      String   // success, failed, partial
  actionsRun  String?  // JSON: which actions ran
  error       String?
  executedAt  DateTime @default(now())
}

// ------------------------------
// SIGNATURE REQUEST (E-İmza Talebi)
// ------------------------------
model SignatureRequest {
  id            String   @id @default(cuid())
  documentId    String
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  status        String   @default("pending") // pending, signed, declined, expired
  signedAt      DateTime?
  signatureData String?  // Base64 encoded signature image
  ipAddress     String?
  userAgent     String?
  expiresAt     DateTime?
  reminderSent  Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ------------------------------
// CLIENT INTAKE FORM
// ------------------------------
model IntakeForm {
  id          String   @id @default(cuid())
  name        String
  description String?
  fields      String   // JSON array of form fields
  practiceArea String?
  isActive    Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  submissions IntakeSubmission[]  // Form submissions
}

// ------------------------------
// INTAKE SUBMISSION
// ------------------------------
model IntakeSubmission {
  id          String   @id @default(cuid())
  formId      String
  form        IntakeForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  data        String   // JSON: submitted form data
  status      String   @default("new") // new, reviewed, converted, rejected
  convertedToClientId String?
  convertedToMatterId String?
  reviewedBy  String?
  reviewedAt  DateTime?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ------------------------------
// SETTLEMENT STATEMENT
// ------------------------------
model SettlementStatement {
  id              String   @id @default(cuid())
  matterId        String
  matter          Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  grossSettlement Float
  attorneyFees    Float
  expenses        Float
  liens           Float?   // Medical liens, etc.
  netToClient     Float
  breakdown       String?  // JSON: detailed breakdown
  status          String   @default("draft") // draft, sent, approved, disputed
  clientApprovedAt DateTime?
  pdfPath         String?  // Generated PDF path
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==============================
// IOLTA TRUST ACCOUNTING SYSTEM
// ABA Model Rule 1.15 Compliant
// ==============================

// ------------------------------
// TRUST BANK ACCOUNT STATUS
// ------------------------------
enum TrustAccountStatus {
  ACTIVE
  INACTIVE
  CLOSED
}

// ------------------------------
// CLIENT LEDGER STATUS
// ------------------------------
enum LedgerStatus {
  ACTIVE
  CLOSED
  FROZEN     // For disputed or audit-hold
}

// ------------------------------
// TRUST TRANSACTION STATUS
// ------------------------------
enum TrustTxStatus {
  PENDING         // Awaiting approval
  APPROVED        // Approved and executed
  REJECTED        // Rejected by approver
  VOIDED          // Voided/reversed
}

// ------------------------------
// TRUST BANK ACCOUNT (IOLTA Account)
// Physical bank account for client funds
// ------------------------------
model TrustBankAccount {
  id                String             @id @default(cuid())
  name              String             // "Primary IOLTA Account"
  bankName          String             // Bank name
  accountNumberEnc  String             // Encrypted account number
  routingNumber     String             // Routing/ABA number
  jurisdiction      String             // "CA", "NY", "TX" - state-specific rules
  
  // Balance is computed from transactions but cached for performance
  currentBalance    Decimal            @default(0) @db.Decimal(15, 2)
  
  status            TrustAccountStatus @default(ACTIVE)
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  closedAt          DateTime?
  closedBy          String?
  
  // Relations
  clientLedgers     ClientTrustLedger[]
  transactions      TrustTransactionV2[]
  reconciliations   ReconciliationRecord[]
}

// ------------------------------
// CLIENT TRUST LEDGER
// Per-client (optionally per-matter) subsidiary ledger
// ------------------------------
model ClientTrustLedger {
  id              String           @id @default(cuid())
  
  clientId        String
  client          Client           @relation(fields: [clientId], references: [id])
  
  matterId        String?          // Optional: per-matter sub-ledgers
  
  trustAccountId  String
  trustAccount    TrustBankAccount @relation(fields: [trustAccountId], references: [id])
  
  // Running balance (updated with each allocation)
  runningBalance  Decimal          @default(0) @db.Decimal(15, 2)
  
  status          LedgerStatus     @default(ACTIVE)
  
  // Notes for the ledger
  notes           String?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  closedAt        DateTime?
  closedBy        String?
  closedReason    String?
  
  // Relations
  allocations     TrustAllocationLine[]
  earnedFees      EarnedFeeEvent[]
  
  @@unique([clientId, matterId, trustAccountId])
}

// ------------------------------
// TRUST TRANSACTION V2 (IOLTA Compliant)
// IMMUTABLE - No update/delete, only void with reversal
// ------------------------------
model TrustTransactionV2 {
  id                  String               @id @default(cuid())
  
  trustAccountId      String
  trustAccount        TrustBankAccount     @relation(fields: [trustAccountId], references: [id])
  
  type                TrustTransactionType // DEPOSIT, WITHDRAWAL, etc.
  amount              Decimal              @db.Decimal(15, 2)
  
  // IMMUTABILITY SUPPORT
  isVoided            Boolean              @default(false)
  voidedAt            DateTime?
  voidedBy            String?
  voidReason          String?
  originalTxId        String?              // If this is a reversal, link to original
  
  // REQUIRED METADATA (for audit)
  description         String
  payorPayee          String               // Who the money came from / went to
  checkNumber         String?
  wireReference       String?
  
  // APPROVAL WORKFLOW
  status              TrustTxStatus        @default(PENDING)
  createdBy           String               // User who initiated
  approvedBy          String?              // Partner/Admin who approved
  approvedAt          DateTime?
  rejectedBy          String?
  rejectedAt          DateTime?
  rejectionReason     String?
  
  // IOLTA TRACKING
  isEarned            Boolean              @default(false) // Has this been earned?
  earnedDate          DateTime?
  
  // Balance snapshots (for audit trail)
  accountBalanceBefore Decimal             @db.Decimal(15, 2)
  accountBalanceAfter  Decimal             @db.Decimal(15, 2)
  
  createdAt           DateTime             @default(now())
  // NO updatedAt - IMMUTABLE
  
  // Relations
  allocations         TrustAllocationLine[]
  earnedFeeEvent      EarnedFeeEvent?
}

// ------------------------------
// TRUST ALLOCATION LINE
// Links one transaction to multiple client ledgers
// Enables split deposits/withdrawals
// ------------------------------
model TrustAllocationLine {
  id              String             @id @default(cuid())
  
  transactionId   String
  transaction     TrustTransactionV2 @relation(fields: [transactionId], references: [id])
  
  ledgerId        String
  ledger          ClientTrustLedger  @relation(fields: [ledgerId], references: [id])
  
  // Amount allocated (positive for deposit, negative for withdrawal)
  amount          Decimal            @db.Decimal(15, 2)
  
  description     String?
  
  // Balance snapshot AFTER this allocation (for audit)
  ledgerBalanceAfter Decimal         @db.Decimal(15, 2)
  
  createdAt       DateTime           @default(now())
  // NO updatedAt - IMMUTABLE
}

// ------------------------------
// EARNED FEE EVENT
// Records when fees are earned and transferred from Trust → Operating
// ------------------------------
model EarnedFeeEvent {
  id              String             @id @default(cuid())
  
  // Invoice that was approved/paid
  invoiceId       String
  
  // Client ledger funds came from
  ledgerId        String
  ledger          ClientTrustLedger  @relation(fields: [ledgerId], references: [id])
  
  // Trust transaction that withdrew funds
  trustTxId       String             @unique
  trustTx         TrustTransactionV2 @relation(fields: [trustTxId], references: [id])
  
  amount          Decimal            @db.Decimal(15, 2)
  
  // Who approved
  approvedBy      String
  approvedAt      DateTime
  
  // For tracking where it went
  operatingReference String?         // Reference in operating account
  
  notes           String?
  
  createdAt       DateTime           @default(now())
}

// ------------------------------
// RECONCILIATION RECORD
// Monthly three-way reconciliation snapshot
// Bank Balance == Trust Ledger == Sum(Client Ledgers)
// ------------------------------
model ReconciliationRecord {
  id                      String           @id @default(cuid())
  
  trustAccountId          String
  trustAccount            TrustBankAccount @relation(fields: [trustAccountId], references: [id])
  
  // Period
  periodStart             DateTime
  periodEnd               DateTime
  
  // THREE-WAY BALANCES
  bankStatementBalance    Decimal          @db.Decimal(15, 2) // From bank statement
  trustLedgerBalance      Decimal          @db.Decimal(15, 2) // Software total
  clientLedgerSumBalance  Decimal          @db.Decimal(15, 2) // Sum of all client ledgers
  
  // RECONCILIATION STATUS
  isReconciled            Boolean          @default(false)
  discrepancyAmount       Decimal?         @db.Decimal(15, 2)
  
  // Outstanding items
  outstandingChecks       String?          @db.Text // JSON: [{checkNumber, amount, date}]
  depositsInTransit       String?          @db.Text // JSON: [{reference, amount, date}]
  otherAdjustments        String?          @db.Text // JSON: other reconciling items
  
  exceptions              String?          @db.Text // JSON: list of exceptions/errors
  notes                   String?          @db.Text
  
  // PREPARED BY
  preparedBy              String
  preparedAt              DateTime
  
  // APPROVED BY (Partner sign-off)
  approvedBy              String?
  approvedAt              DateTime?
  
  createdAt               DateTime         @default(now())
  // NO updatedAt - IMMUTABLE once approved
}

// ------------------------------
// TRUST AUDIT LOG (IMMUTABLE)
// Append-only audit trail for all trust actions
// Bar auditors require this
// ------------------------------
model TrustAuditLog {
  id              String   @id @default(cuid())
  
  // WHO
  userId          String?
  userEmail       String?
  userRole        String?
  ipAddress       String?
  userAgent       String?
  
  // WHAT
  action          String   // TRUST_DEPOSIT, TRUST_WITHDRAWAL, VOID_TX, RECONCILE, APPROVE, etc.
  entityType      String   // TrustTransactionV2, ClientTrustLedger, ReconciliationRecord, etc.
  entityId        String?
  
  // DETAILS (for forensic analysis)
  previousState   String?  @db.Text // JSON snapshot before action
  newState        String?  @db.Text // JSON snapshot after action
  metadata        String?  @db.Text // JSON: additional context
  
  // Amounts involved
  amount          Decimal? @db.Decimal(15, 2)
  
  // Related entities
  trustAccountId  String?
  clientLedgerId  String?
  transactionId   String?
  
  createdAt       DateTime @default(now())
  
  // IMMUTABLE - NO UPDATE OR DELETE
  // Indexes for efficient querying
  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
  @@index([trustAccountId])
  @@index([createdAt])
}

// ------------------------------
// JURISDICTION CONFIG
// State-specific trust rules
// ------------------------------
model JurisdictionConfig {
  id              String   @id @default(cuid())
  
  stateCode       String   @unique // "CA", "NY", "TX", etc.
  stateName       String
  
  // Interest handling
  interestToBar   Boolean  @default(true)  // IOLTA interest goes to bar foundation?
  interestRate    Decimal? @db.Decimal(5, 4)
  
  // Record retention
  retentionYears  Int      @default(5)
  
  // Reporting requirements
  reportingFreq   String   @default("ANNUAL") // ANNUAL, QUARTERLY
  
  // Minimum balance rules
  minBalanceForInterest Decimal? @db.Decimal(15, 2)
  
  // Special rules (JSON)
  specialRules    String?  @db.Text // JSON: state-specific rules
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}